---
import { SITE, LOGO_IMAGE } from '../config';
import { Menu, X, Globe, ChevronDown, Check, Moon, Sun } from 'lucide-react';
import { ui, defaultLang, languages } from '../i18n/ui';

const { nav, i18n, customPages } = SITE;
---

<header class="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-gray-100 transition-colors duration-300">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo & Name -->
      <div class="flex items-center gap-3">
        <a href="/" class="flex items-center gap-2 group">
          {LOGO_IMAGE.enable && SITE.logo && <img src={SITE.logo} alt="Logo" class="h-8 w-8 object-contain" />}
          <div class="flex flex-col sm:flex-row sm:items-end sm:gap-2 leading-tight">
            <span class="font-bold text-gray-900 text-lg leading-tight group-hover:text-blue-600 transition-colors">
              {SITE.labName}
            </span>
            <span class="hidden sm:inline text-gray-500 text-sm font-light pb-0.5">
              {SITE.university}
            </span>
          </div>
        </a>
      </div>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex gap-6 items-center">
        {nav.map(item => (
          <a 
            href={item.link} 
            class="text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors"
            data-i18n-key={`nav.${item.key}`}
          >
            {item.text}
          </a>
        ))}
        
        <!-- Custom Pages -->
        {customPages && customPages.map(item => (
           <a 
             href={item.link} 
            class="text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors"
             data-i18n-key={item.key} 
           >
             {item.text}
           </a>
        ))}
        
        
        
        {i18n.enabled && (
          <div class="relative ml-2 group">
            <button 
              class="flex items-center gap-1 px-3 py-2 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-600 transition-colors outline-none"
              aria-label="Select Language"
            >
              <Globe className="w-4 h-4" />
              <span class="text-xs font-medium uppercase" id="current-lang-label">ZH</span>
              <ChevronDown className="w-3 h-3 opacity-50" />
            </button>
            
            <!-- Dropdown Menu -->
            <div class="absolute right-0 pt-2 w-40 hidden group-hover:block transform origin-top-right transition-all">
              <div class="bg-white rounded-xl shadow-xl border border-gray-100 py-2">
                {Object.entries(languages).map(([code, label]) => (
                  <button
                    class="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors lang-option flex items-center justify-between group/item"
                    data-lang={code}
                  >
                    <span>{label}</span>
                    <Check className="w-4 h-4 text-blue-600 opacity-0 group-[.active]/item:opacity-100 transition-opacity" />
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}
      </nav>

      <!-- Mobile Menu Button -->
      <button 
        id="mobile-menu-btn" 
        class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-md touch-manipulation" 
        aria-label="Toggle menu"
        aria-controls="mobile-menu"
        aria-expanded="false"
        onclick="window.toggleMobileMenu(event)"
      >
        <span class="icon-menu block">
          <Menu className="w-6 h-6" />
        </span>
        <span class="icon-close hidden">
          <X className="w-6 h-6" />
        </span>
      </button>
    </div>
  </div>

  <!-- Mobile Nav Backdrop -->
  <div 
    id="mobile-menu-backdrop" 
    class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[60] hidden transition-opacity duration-300 md:hidden"
    onclick="window.closeMobileMenu()"
  ></div>

  <!-- Mobile Nav Panel -->
  <div 
    id="mobile-menu" 
    class="fixed inset-y-0 right-0 z-[70] w-[280px] sm:w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out md:hidden flex flex-col h-full"
    role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="mobile-menu-title"
  >
    <div class="h-16 px-4 flex justify-between items-center border-b border-gray-100">
      <span id="mobile-menu-title" class="font-semibold text-gray-900">{SITE.labName}</span>
      <button 
        id="mobile-menu-close"
        class="p-2 text-gray-600 hover:bg-gray-100 rounded-md"
        onclick="window.closeMobileMenu()"
        aria-label="Close menu"
      >
        <X className="w-6 h-6" />
      </button>
    </div>
    
    <div class="flex-1 overflow-y-auto px-4 py-4 space-y-2">
      {nav.map(item => (
        <a 
          href={item.link} 
          class="block px-4 py-3 text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors"
          data-i18n-key={`nav.${item.key}`}
          onclick="window.closeMobileMenu()"
        >
          {item.text}
        </a>
      ))}
      
      <!-- Custom Pages Mobile -->
      {customPages && customPages.map(item => (
        <a 
          href={item.link} 
          class="block px-4 py-3 text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors"
          data-i18n-key={item.key}
          onclick="window.closeMobileMenu()"
        >
          {item.text}
        </a>
      ))}

      {i18n.enabled && (
        <div class="border-t border-gray-100 mt-4 pt-4">
          <div class="px-4 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
            Language
          </div>
          <div class="grid grid-cols-2 gap-3 px-2 pb-2">
            {Object.entries(languages).map(([code, label]) => (
              <button
                class="text-center px-3 py-2.5 text-sm font-medium rounded-xl text-gray-600 bg-gray-50 hover:bg-blue-50 hover:text-blue-600 transition-all lang-option mobile-lang-option border border-transparent hover:border-blue-100"
                data-lang={code}
                onclick="window.setLanguage && window.setLanguage(this.getAttribute('data-lang')); window.closeMobileMenu()"
              >
                {label}
              </button>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</header>

<script is:inline>
  (function() {
    const btn = document.getElementById('mobile-menu-btn');
    const menu = document.getElementById('mobile-menu');
    const backdrop = document.getElementById('mobile-menu-backdrop');
    const iconMenu = document.querySelector('.icon-menu');
    const iconClose = document.querySelector('.icon-close');
    const closeBtn = document.getElementById('mobile-menu-close');
    const langLabel = document.getElementById('current-lang-label');

    let lastFocusedEl = null;

    function setAria(open) {
      btn?.setAttribute('aria-expanded', open ? 'true' : 'false');
      menu?.setAttribute('aria-hidden', open ? 'false' : 'true');
    }

    function trapFocus(e) {
      if (!menu || !menu.contains(document.activeElement)) return;
      if (e.key !== 'Tab') return;
      const focusable = menu.querySelectorAll('a, button, input, [tabindex]:not([tabindex="-1"])');
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }

    function onKeydown(e) {
      if (e.key === 'Escape') {
        window.closeMobileMenu();
      } else {
        trapFocus(e);
      }
    }

    function openMenu() {
      menu?.classList.remove('translate-x-full');
      backdrop?.classList.remove('hidden');
      iconMenu?.classList.add('hidden');
      iconClose?.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      setAria(true);
      lastFocusedEl = document.activeElement;
      (closeBtn || menu?.querySelector('button') || menu)?.focus?.();
      document.addEventListener('keydown', onKeydown);
    }

    window.closeMobileMenu = function() {
      menu?.classList.add('translate-x-full');
      backdrop?.classList.add('hidden');
      iconMenu?.classList.remove('hidden');
      iconClose?.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      setAria(false);
      document.removeEventListener('keydown', onKeydown);
      if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') {
        lastFocusedEl.focus();
      } else {
        btn?.focus?.();
      }
    };

    window.toggleMobileMenu = function(e) {
      if (e) e.stopPropagation();
      if (!menu) return;
      if (menu.classList.contains('translate-x-full')) openMenu();
      else window.closeMobileMenu();
    };

    closeBtn?.addEventListener('click', window.closeMobileMenu);
    backdrop?.addEventListener('click', window.closeMobileMenu);

    // Close on link click in drawer
    menu?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', window.closeMobileMenu);
    });

    // Language handling
    function updateHeaderLang(lang) {
      if (langLabel) langLabel.textContent = lang.toUpperCase();
      document.querySelectorAll('.lang-option').forEach(btn => {
        const btnLang = btn.getAttribute('data-lang');
        if (btnLang === lang) {
          btn.classList.add('text-blue-600', 'bg-blue-50', 'border-blue-200');
        } else {
          btn.classList.remove('text-blue-600', 'bg-blue-50', 'border-blue-200');
        }
      });
    }

    window.addEventListener('language-change', (e) => {
      updateHeaderLang(e.detail.lang);
    });

    try {
      const saved = localStorage.getItem('preferred-lang') || 'zh';
      updateHeaderLang(saved);
    } catch {}

    document.querySelectorAll('.lang-option:not(.mobile-lang-option)').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        if (window.setLanguage) window.setLanguage(lang);
      });
    });

    // Auto close when resizing to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) window.closeMobileMenu();
    });
  })();
</script>
